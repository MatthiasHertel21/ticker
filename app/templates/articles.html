{% extends "base.html" %}

{% block title %}News ({{ articles|length }}){% endblock %}

{% block page_subtitle %}{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<style>
/* Override content-area padding for this page */
.content-area {
    padding: 0 !important;
}
</style>

<div class="container-fluid px-0" style="margin: 0; padding: 0;">
    
    <!-- Articles Grid -->
    <div class="row g-0" style="margin: 0;">
        {% for article in articles %}
        {% if article.relevance_score != 'spam' %}
        <div class="col-12">
            <div class="article-card mb-3" data-article-id="{{ article.id }}">
                <div class="article-body">
                    <!-- Article Header with Date, Channel, Age -->
                    <div class="d-flex justify-content-between align-items-start mb-0 p-3 bg-primary bg-opacity-10">
                        <div class="article-meta flex-grow-1">
                            <div class="d-flex align-items-start gap-2 mb-0">
                                {% if article.url %}
                                <a href="{{ article.url }}" target="_blank" class="text-decoration-none">
                                    <span class="badge bg-primary">{{ (article.source or article.channel) | clean_channel_name }}</span>
                                </a>
                                {% else %}
                                <span class="badge bg-primary">{{ (article.source or article.channel) | clean_channel_name }}</span>
                                {% endif %}
                                {% if article.message_age %}
                                <span class="badge bg-secondary">{{ article.message_age | shorten_time_tag }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Rating Buttons -->
                        <div class="rating-buttons-container">
                            <button class="btn btn-sm btn-outline-primary {{ 'active' if article.relevance_score == 'favorite' else '' }}" 
                                    onclick="updateRating('{{ article.id }}', 'favorite', this)" 
                                    title="Als Favorit markieren">
                                <i class="bi bi-heart-fill"></i>
                            </button><!--
                            --><button class="btn btn-sm btn-outline-danger {{ 'active' if article.relevance_score == 'spam' else '' }}" 
                                    onclick="updateRating('{{ article.id }}', 'spam', this)" 
                                    title="Als Spam markieren">
                                <i class="bi bi-trash-fill"></i>
                            </button><!--
                            --><button class="btn btn-sm btn-outline-secondary" 
                                    onclick="deleteArticle('{{ article.id }}', this)" 
                                    title="Artikel löschen">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-3">
                    <!-- Article Title -->
                    {% if article.title %}
                    <h5 class="article-title mb-2">
                        {% if article.url %}
                        <a href="{{ article.url }}" target="_blank" class="text-decoration-none">
                            {{ article.title }}
                        </a>
                        {% else %}
                        {{ article.title }}
                        {% endif %}
                    </h5>
                    {% endif %}

                    <!-- Link Previews (loaded on demand) -->
                    {% if article.content and 'http' in article.content %}
                    <div class="link-previews mb-3">
                        {% if article.link_previews %}
                        <!-- Show instant preview immediately -->
                        <div id="preview-{{ article.id }}" class="preview-container mt-2">
                            {% for preview in article.link_previews %}
                            {% if preview.type == 'oembed' and preview.html %}
                            <!-- oEmbed with HTML (Videos, Tweets, etc.) -->
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="embed-responsive mb-2">
                                    {{ preview.html | safe }}
                                </div>
                                {% if preview.title %}
                                <h6 class="mb-1 fw-bold">
                                    <a href="{{ preview.url }}" target="_blank" class="text-decoration-none">
                                        {{ preview.title[:80] }}{% if preview.title|length > 80 %}...{% endif %}
                                    </a>
                                </h6>
                                {% endif %}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-lightning-fill me-1 text-warning"></i>
                                    <span>Instant-Vorschau</span>
                                    {% if preview.site_name %}<span class="ms-2">{{ preview.site_name }}</span>{% endif %}
                                </div>
                            </div>
                            {% else %}
                            <!-- Standard Meta Preview -->
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="row g-2">
                                    {% if preview.image %}
                                    <div class="col-auto">
                                        <img src="{{ preview.image }}" alt="Preview" 
                                             class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                    {% endif %}
                                    <div class="col">
                                        <div class="link-preview-content">
                                            {% if preview.title %}
                                            <h6 class="mb-1 fw-bold">
                                                <a href="{{ preview.url }}" target="_blank" class="text-decoration-none">
                                                    {{ preview.title[:80] }}{% if preview.title|length > 80 %}...{% endif %}
                                                </a>
                                            </h6>
                                            {% endif %}
                                            {% if preview.description %}
                                            <p class="mb-1 text-muted small">
                                                {{ preview.description[:120] }}{% if preview.description|length > 120 %}...{% endif %}
                                            </p>
                                            {% endif %}
                                            <div class="d-flex align-items-center text-muted small">
                                                {% if preview.favicon %}
                                                <img src="{{ preview.favicon }}" alt="Site" 
                                                     class="me-1" style="width: 16px; height: 16px;">
                                                {% endif %}
                                                <span>{{ preview.site_name or preview.url.replace('https://', '').replace('http://', '') }}</span>
                                                <i class="bi bi-lightning-fill ms-1 text-warning" title="Instant-Vorschau"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <button class="btn btn-sm btn-outline-info" onclick="loadLinkPreview('{{ article.id }}', this)">
                            <i class="bi bi-link-45deg"></i> Website-Vorschau laden
                        </button>
                        <div id="preview-{{ article.id }}" class="preview-container d-none mt-2"></div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Article Content -->
                    {% if article.content %}
                    <div class="article-content mb-3">
                        {% set clean_content = article.content | render_telegram_content_clean %}
                        {% set is_long = article.content | length > 300 %}
                        {% if clean_content %}
                        <div class="content-preview">
                            {% if is_long %}
                                {{ clean_content[:300] | safe }}
                                <span class="text-muted">...</span>
                                <button class="btn btn-link btn-sm p-0 ms-1" onclick="toggleFullContent(this)">
                                    <i class="bi bi-chevron-down me-1"></i>Mehr anzeigen
                                </button>
                            {% else %}
                                {{ clean_content | safe }}
                            {% endif %}
                        </div>
                        {% if is_long %}
                        <div class="full-content d-none mt-2">
                            <div class="border-top pt-2">
                                {{ clean_content | safe }}
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
        {% endfor %}
    </div>
    
    {% if not articles %}
    <div class="text-center py-5">
        <i class="bi bi-newspaper display-1 text-muted"></i>
        <h3 class="text-muted mt-3">Keine Artikel gefunden</h3>
        <p class="text-muted">Starte das Scraping, um neue Artikel zu sammeln.</p>
    </div>
    {% endif %}
</div>

<script>
function updateRating(articleId, rating, button) {
    const buttons = button.parentElement.querySelectorAll('.btn');
    
    fetch('/articles/rate/' + articleId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({rating: rating})
    })
    .then(response => response.json())
    .then(data => {
        buttons.forEach(btn => btn.classList.remove('active'));
        if (data.success) {
            button.classList.add('active');
            // Hide article if marked as spam
            if (rating === 'spam') {
                const article = button.closest('.col-12');
                if (article) {
                    article.style.opacity = '0';
                    article.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        article.style.display = 'none';
                    }, 300);
                }
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteArticle(articleId, button) {
    if (confirm('Artikel wirklich löschen?')) {
        fetch('/articles/delete/' + articleId, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const card = button.closest('.col-12');
                if (card) {
                    card.remove();
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function toggleFullContent(button) {
    const articleCard = button.closest('.article-card');
    const preview = articleCard.querySelector('.content-preview');
    const fullContent = articleCard.querySelector('.full-content');
    
    if (fullContent.classList.contains('d-none')) {
        fullContent.classList.remove('d-none');
        preview.style.display = 'none';
        button.innerHTML = '<i class="bi bi-chevron-up me-1"></i>Weniger anzeigen';
    } else {
        fullContent.classList.add('d-none');
        preview.style.display = 'block';
        button.innerHTML = '<i class="bi bi-chevron-down me-1"></i>Mehr anzeigen';
    }
}

function loadLinkPreview(articleId, button) {
    const container = document.getElementById(`preview-${articleId}`);
    
    // Show loading state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Lade...';
    button.disabled = true;
    
    // Make AJAX request for link preview
    fetch(`/articles/${articleId}/preview`)
        .then(response => response.json())
        .then(data => {
            if (data.previews && data.previews.length > 0) {
                // Render previews
                let html = '';
                data.previews.forEach(preview => {
                    if (preview.type === 'oembed' && preview.html) {
                        // oEmbed mit HTML (Videos, Tweets, etc.)
                        html += `
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="embed-responsive mb-2">
                                    ${preview.html}
                                </div>
                                ${preview.title ? `
                                <h6 class="mb-1 fw-bold">
                                    <a href="${preview.url}" target="_blank" class="text-decoration-none">
                                        ${preview.title.substring(0, 80)}${preview.title.length > 80 ? '...' : ''}
                                    </a>
                                </h6>
                                ` : ''}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-lightning-fill me-1 text-warning"></i>
                                    <span>Schnell-Vorschau</span>
                                    ${preview.site_name ? `<span class="ms-2">${preview.site_name}</span>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        // Standard Meta-Vorschau
                        html += `
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="row g-2">
                                    ${preview.image ? `
                                    <div class="col-auto">
                                        <img src="${preview.image}" alt="Preview" 
                                             class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                    ` : ''}
                                    <div class="col">
                                        <div class="link-preview-content">
                                            ${preview.title ? `
                                            <h6 class="mb-1 fw-bold">
                                                <a href="${preview.url}" target="_blank" class="text-decoration-none">
                                                    ${preview.title.substring(0, 80)}${preview.title.length > 80 ? '...' : ''}
                                                </a>
                                            </h6>
                                            ` : ''}
                                            ${preview.description ? `
                                            <p class="mb-1 text-muted small">
                                                ${preview.description.substring(0, 120)}${preview.description.length > 120 ? '...' : ''}
                                            </p>
                                            ` : ''}
                                            <div class="d-flex align-items-center text-muted small">
                                                ${preview.favicon ? `
                                                <img src="${preview.favicon}" alt="Site" 
                                                     class="me-1" style="width: 16px; height: 16px;">
                                                ` : ''}
                                                <span>${preview.site_name || preview.url.replace('https://', '').replace('http://', '')}</span>
                                                ${preview.type === 'oembed' ? '<i class="bi bi-lightning-fill ms-1 text-warning" title="Schnell-Vorschau"></i>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html;
                container.classList.remove('d-none');
                button.style.display = 'none';
            } else {
                button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Keine Vorschau verfügbar';
                button.classList.add('btn-outline-secondary');
                button.classList.remove('btn-outline-info');
            }
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Fehler beim Laden';
            button.classList.add('btn-outline-danger');
            button.classList.remove('btn-outline-info');
        })
        .finally(() => {
            button.disabled = false;
        });
}
</script>

<style>
/* Override content-area padding for this page */
.content-area {
    padding: 0 !important;
}

.article-card {
    border: none;
    border-radius: 0;
    background: white;
    margin-bottom: 1rem;
    box-shadow: none;
}

.rating-buttons-container {
    white-space: nowrap;
    font-size: 0; /* Removes space between inline-block elements */
    align-self: flex-start; /* Force top alignment */
}

.rating-buttons-container .btn {
    font-size: 0.85rem;
    margin: 0;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    min-width: 2rem;
    display: inline-block;
    vertical-align: top;
    line-height: 1.2;
}

/* Remove any borders/lines */
.article-card .article-body {
    border: none !important;
    box-shadow: none !important;
}

/* Ensure badges align to top */
.badge {
    vertical-align: top;
    line-height: 1.2;
}

.rating-buttons .btn.active {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.article-title {
    font-weight: 600;
    line-height: 1.3;
}

.link-preview-card {
    border: 1px solid #dee2e6 !important;
    background: #f8f9fa !important;
}

/* Hide spam articles with smooth transition */
.article-card[data-spam="true"] {
    opacity: 0;
    transform: scale(0.95);
    transition: all 0.3s ease;
    pointer-events: none;
    height: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
    border: none;
}
</style>
{% endblock %}