{% extends "base.html" %}

{% block title %}News ({{ articles|length }}){% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<style>
/* Override content-area padding for this page */
.content-area { padding: 0 !important; }
/* Abstand Navbar -> erster Artikel */
.articles-header-spacer { height: .5rem; }
/* Icon Buttons ohne Rahmen */
.rating-buttons-container .btn { border: none !important; background: transparent !important; box-shadow:none !important; padding:.25rem .45rem; }
.rating-buttons-container .btn:hover { background: rgba(0,0,0,0.06) !important; }
.rating-buttons-container .btn.active { background: rgba(13,110,253,.15) !important; }
/* Horizontal jitter verhindern */
html { overflow-y: scroll; }
/* Kleiner Abstand zwischen Header-Balken und Titel */
.article-card .article-body > .p-4.pt-0 { padding-top:.5rem !important; }
/* Container Padding entfernen */
.container-fluid.articles-container { padding-left:0 !important; padding-right:0 !important; }
/* Source Icon Badge */
.source-badge-icon { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:6px; font-size:16px; }
.source-badge-icon.telegram { background:#229ED9; color:#fff; }
.source-badge-icon.rss { background:#ff8800; color:#fff; }
.source-badge-icon.web { background:#6c757d; color:#fff; }
.source-badge-icon.twitter { background:#000; color:#fff; }
.fade-out-shrink { transition: opacity .25s ease, transform .25s ease; opacity:0; transform:scale(.96); }
</style>

<div class="container-fluid px-0 articles-container" style="margin:0;">
    
    <!-- Articles Grid -->
    <div class="row g-0" style="margin: 0;">
        {% for article in articles %}
        {% if article.relevance_score != 'spam' %}
        <div class="col-12">
            <div class="article-card mb-3" data-article-id="{{ article.id }}">
                <div class="article-body">
                    <!-- Article Header with Date, Channel, Age -->
                    <div class="d-flex justify-content-between align-items-start mb-0 px-3 py-2 bg-secondary bg-opacity-25">
                        <!-- Tags Container -->
            <div class="d-flex align-items-start gap-2 mb-0">
                            {% set platform = article.platform or article.source_type %}
                            {% if platform %}
                                {% set icon_class = 'bi-question' %}
                                {% if platform == 'telegram' %}{% set icon_class = 'bi-telegram' %}{% endif %}
                                {% if platform == 'rss' %}{% set icon_class = 'bi-rss' %}{% endif %}
                                {% if platform == 'web' %}{% set icon_class = 'bi-globe' %}{% endif %}
                                {% if platform == 'twitter' %}{% set icon_class = 'bi-twitter-x' %}{% endif %}
                {% set channel_name = (article.source or article.channel) | clean_channel_name %}
                <span class="source-badge-icon {{ platform }}" title="{{ channel_name }}"><i class="bi {{ icon_class }}"></i></span>
                <span class="small fw-semibold mt-1"><a href="/sources/manage" class="text-decoration-none text-reset" title="Quelle öffnen">{{ channel_name }}</a></span>
                            {% endif %}
                            {% if article.message_age %}
                            <span class="badge bg-secondary">{{ article.message_age | shorten_time_tag }}</span>
                            {% endif %}
                        </div>
                        
                        <!-- Rating Buttons -->
                        <div class="rating-buttons-container d-flex align-items-start">
                            <button class="btn btn-sm {{ 'active' if article.relevance_score == 'favorite' else '' }}" 
                                    onclick="updateRating('{{ article.id }}', 'favorite', this)" 
                                    title="Als Favorit markieren">
                                <i class="bi bi-heart-fill text-muted"></i>
                            </button><!--
                            --><button class="btn btn-sm {{ 'active' if article.relevance_score == 'spam' else '' }}" 
                                    onclick="updateRating('{{ article.id }}', 'spam', this)" 
                                    title="Als Spam markieren">
                                <i class="bi bi-trash-fill text-muted"></i>
                            </button><!--
                            --><button class="btn btn-sm" 
                                    onclick="deleteArticle('{{ article.id }}', this)" 
                                    title="Artikel löschen">
                                <i class="bi bi-x-lg text-muted"></i>
                            </button>
                        </div>
                    </div>

                    <div class="pt-2 px-0">
                    <!-- Article Title -->
                    {% if article.title %}
                    <h5 class="article-title mb-2">
                        {% if article.url %}
                        <a href="{{ article.url }}" target="_blank" class="text-decoration-none">
                            {{ article.title }}
                        </a>
                        {% else %}
                        {{ article.title }}
                        {% endif %}
                    </h5>
                    {% endif %}

                    <!-- Link Previews (automatically loaded) -->
                    {% if article.content and 'http' in article.content %}
                    <div class="link-previews mb-3">
                        {% if article.link_previews %}
                        <!-- Show instant preview immediately -->
                        <div id="preview-{{ article.id }}" class="preview-container mt-2">
                            {% for preview in article.link_previews %}
                            {% if preview.type == 'oembed' and preview.html %}
                            <!-- oEmbed with HTML (Videos, Tweets, etc.) -->
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="embed-responsive mb-2">
                                    {{ preview.html | safe }}
                                </div>
                                {% if preview.title %}
                                <h6 class="mb-1 fw-bold">
                                    <a href="{{ preview.url }}" target="_blank" class="text-decoration-none">
                                        {{ preview.title[:80] }}{% if preview.title|length > 80 %}...{% endif %}
                                    </a>
                                </h6>
                                {% endif %}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-lightning-fill me-1 text-warning"></i>
                                    <span>Instant-Vorschau</span>
                                    {% if preview.site_name %}<span class="ms-2">{{ preview.site_name }}</span>{% endif %}
                                </div>
                            </div>
                            {% else %}
                            <!-- Standard Meta Preview -->
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="row g-2">
                                    {% if preview.image %}
                                    <div class="col-auto">
                                        <img src="{{ preview.image }}" alt="Preview" 
                                             class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                    {% endif %}
                                    <div class="col">
                                        <div class="link-preview-content">
                                            {% if preview.title %}
                                            <h6 class="mb-1 fw-bold">
                                                <a href="{{ preview.url }}" target="_blank" class="text-decoration-none">
                                                    {{ preview.title[:80] }}{% if preview.title|length > 80 %}...{% endif %}
                                                </a>
                                            </h6>
                                            {% endif %}
                                            {% if preview.description %}
                                            <p class="mb-1 text-muted small">
                                                {{ preview.description[:120] }}{% if preview.description|length > 120 %}...{% endif %}
                                            </p>
                                            {% endif %}
                                            <div class="d-flex align-items-center text-muted small">
                                                {% if preview.favicon %}
                                                <img src="{{ preview.favicon }}" alt="Site" 
                                                     class="me-1" style="width: 16px; height: 16px;">
                                                {% endif %}
                                                <span>{{ preview.site_name or preview.url.replace('https://', '').replace('http://', '') }}</span>
                                                <i class="bi bi-lightning-fill ms-1 text-warning" title="Instant-Vorschau"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <!-- Auto-load previews for articles without them -->
                        <div id="preview-{{ article.id }}" class="preview-container mt-2" 
                             data-auto-load="true" 
                             data-article-id="{{ article.id }}"></div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Article Content -->
                    {% if article.content %}
                    <div class="article-content mb-3">
                        {% set clean_content = article.content | render_telegram_content_clean %}
                        {% set truncated = clean_content | truncate_chars_media(640,1) %}
                        {% if truncated.html %}
                        <div class="content-preview">
                            {{ truncated.html | safe }}
                            {% if truncated.truncated %}
                            <span class="badge bg-primary bg-opacity-75 ms-2 more-toggle" data-loaded="0" onclick="toggleFullContentLazy(this)" style="cursor:pointer;">Mehr anzeigen</span>
                            {% endif %}
                        </div>
                        <div class="full-content d-none mt-2" data-article-id="{{ article.id }}"></div>
                        {% endif %}
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
        {% endfor %}
    </div>
    
    {% if not articles %}
    <div class="text-center py-5">
        <i class="bi bi-newspaper display-1 text-muted"></i>
        <h3 class="text-muted mt-3">Keine Artikel gefunden</h3>
        <p class="text-muted">Starte das Scraping, um neue Artikel zu sammeln.</p>
    </div>
    {% endif %}
    
    <!-- Paginierung -->
    {% if articles %}
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3 px-3">
        <div class="text-muted small">
            Zeige {{ ((page-1) * per_page + 1) }} - {{ ((page-1) * per_page + articles|length) }} von {{ total_articles }} Artikeln
        </div>
        <div>
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}&per_page={{ per_page }}" class="btn btn-outline-primary btn-sm me-2">
                <i class="bi bi-chevron-left"></i> Vorherige
            </a>
            {% endif %}
            {% if has_more %}
            <a href="?page={{ page + 1 }}&per_page={{ per_page }}" class="btn btn-outline-primary btn-sm">
                Nächste <i class="bi bi-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function updateRating(articleId, rating, button) {
    const buttons = button.parentElement.querySelectorAll('.btn');
    
    fetch('/articles/rate/' + articleId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({rating: rating})
    })
    .then(response => response.json())
    .then(data => {
        buttons.forEach(btn => btn.classList.remove('active'));
        if (data.success) {
            button.classList.add('active');
            // Hide article if marked as spam
            if (rating === 'spam') {
                const article = button.closest('.col-12');
                if (article) {
                    article.style.opacity = '0';
                    article.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        article.style.display = 'none';
                    }, 300);
                }
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteArticle(articleId, button) {
    const wrapper = button.closest('.col-12');
    if (!wrapper) return;
    const card = wrapper.querySelector('.article-card');
    if (card) card.classList.add('fade-out-shrink');
    setTimeout(()=> { wrapper.remove(); }, 250);
    fetch('/articles/delete/' + articleId, { method:'POST' })
        .then(r=>r.json())
        .then(data=>{ if(!data.success){ console.warn('Delete failed backend', data.error); }})
        .catch(err=>console.error('Delete error', err));
}

function toggleFullContentLazy(badge){
    const articleCard = badge.closest('.article-card');
    if(!articleCard) return;
    const fullContent = articleCard.querySelector('.full-content');
    const previewWrapper = articleCard.querySelector('.content-preview');
    const loaded = badge.getAttribute('data-loaded') === '1';
    const articleId = fullContent.getAttribute('data-article-id');
    const expanding = fullContent.classList.contains('d-none');
    if(expanding){
        if(!loaded){
            badge.textContent = 'Lade…';
            fetch(`/articles/${articleId}/full`)
                .then(r=>r.json())
                .then(data=>{
                    if(data.content){
                        fullContent.innerHTML = `<div class='border-top pt-2'>${data.content}</div>`;
                        badge.setAttribute('data-loaded','1');
                        badge.textContent = 'Weniger';
                        fullContent.classList.remove('d-none');
                        previewWrapper.style.display='none';
                    } else {
                        badge.textContent = 'Fehler';
                    }
                })
                .catch(()=>{ badge.textContent='Fehler'; })
            ;
        } else {
            fullContent.classList.remove('d-none');
            previewWrapper.style.display='none';
            badge.textContent='Weniger';
        }
    } else {
        fullContent.classList.add('d-none');
        previewWrapper.style.display='block';
        badge.textContent='Mehr anzeigen';
    }
}

// Auto-load previews for articles without them (max 10 to avoid server overload)
document.addEventListener('DOMContentLoaded', function() {
    const autoLoadContainers = document.querySelectorAll('[data-auto-load="true"]');
    
    // Load previews with a slight delay to not overwhelm the server
    // Only load first 10 for performance
    const maxAutoLoad = Math.min(autoLoadContainers.length, 10);
    
    for (let i = 0; i < maxAutoLoad; i++) {
        setTimeout(() => {
            loadPreviewForContainer(autoLoadContainers[i]);
        }, i * 800); // 800ms delay between each request
    }
});

// Click auf letzten Scrape-Zeitpunkt startet neues Scraping (falls global startScraping vorhanden)
document.addEventListener('DOMContentLoaded', () => {
    const t = document.getElementById('lastScrapeTime');
    if (t && typeof startScraping === 'function') {
        t.addEventListener('click', () => startScraping());
    }
});

function loadPreviewForContainer(container) {
    const articleId = container.dataset.articleId;
    
    // Make AJAX request for link preview
    fetch(`/articles/${articleId}/preview`)
        .then(response => response.json())
        .then(data => {
            if (data.previews && data.previews.length > 0) {
                // Render previews
                let html = '';
                data.previews.forEach(preview => {
                    if (preview.type === 'oembed' && preview.html) {
                        // oEmbed mit HTML (Videos, Tweets, etc.)
                        html += `
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="embed-responsive mb-2">
                                    ${preview.html}
                                </div>
                                ${preview.title ? `
                                <h6 class="mb-1 fw-bold">
                                    <a href="${preview.url}" target="_blank" class="text-decoration-none">
                                        ${preview.title.substring(0, 80)}${preview.title.length > 80 ? '...' : ''}
                                    </a>
                                </h6>
                                ` : ''}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-lightning-fill me-1 text-warning"></i>
                                    <span>Instant-Vorschau</span>
                                    ${preview.site_name ? `<span class="ms-2">${preview.site_name}</span>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        // Standard Meta Preview
                        html += `
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="row g-2">
                                    ${preview.image ? `
                                    <div class="col-auto">
                                        <img src="${preview.image}" alt="Preview" 
                                             class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                    ` : ''}
                                    <div class="col">
                                        <div class="link-preview-content">
                                            ${preview.title ? `
                                            <h6 class="mb-1 fw-bold">
                                                <a href="${preview.url}" target="_blank" class="text-decoration-none">
                                                    ${preview.title.substring(0, 80)}${preview.title.length > 80 ? '...' : ''}
                                                </a>
                                            </h6>
                                            ` : ''}
                                            ${preview.description ? `
                                            <p class="mb-1 text-muted small">
                                                ${preview.description.substring(0, 120)}${preview.description.length > 120 ? '...' : ''}
                                            </p>
                                            ` : ''}
                                            <div class="d-flex align-items-center text-muted small">
                                                ${preview.favicon ? `
                                                <img src="${preview.favicon}" alt="Site" 
                                                     class="me-1" style="width: 16px; height: 16px;">
                                                ` : ''}
                                                <span>${preview.site_name || preview.url.replace('https://', '').replace('http://', '')}</span>
                                                ${preview.type === 'oembed' ? '<i class="bi bi-lightning-fill ms-1 text-warning" title="Schnell-Vorschau"></i>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html;
                container.classList.remove('d-none');
            }
            // If no previews found, simply don't show anything (container stays empty)
        })
        .catch(error => {
            console.debug('No preview available for article:', articleId);
            // Silently fail - no preview means no preview, no error message needed
        });
}

function loadLinkPreview(articleId, button) {
    const container = document.getElementById(`preview-${articleId}`);
    
    // Show loading state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Lade...';
    button.disabled = true;
    
    // Make AJAX request for link preview
    fetch(`/articles/${articleId}/preview`)
        .then(response => response.json())
        .then(data => {
            if (data.previews && data.previews.length > 0) {
                // Render previews
                let html = '';
                data.previews.forEach(preview => {
                    if (preview.type === 'oembed' && preview.html) {
                        // oEmbed mit HTML (Videos, Tweets, etc.)
                        html += `
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="embed-responsive mb-2">
                                    ${preview.html}
                                </div>
                                ${preview.title ? `
                                <h6 class="mb-1 fw-bold">
                                    <a href="${preview.url}" target="_blank" class="text-decoration-none">
                                        ${preview.title.substring(0, 80)}${preview.title.length > 80 ? '...' : ''}
                                    </a>
                                </h6>
                                ` : ''}
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-lightning-fill me-1 text-warning"></i>
                                    <span>Schnell-Vorschau</span>
                                    ${preview.site_name ? `<span class="ms-2">${preview.site_name}</span>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        // Standard Meta-Vorschau
                        html += `
                            <div class="link-preview-card border rounded p-3 mb-2 bg-light">
                                <div class="row g-2">
                                    ${preview.image ? `
                                    <div class="col-auto">
                                        <img src="${preview.image}" alt="Preview" 
                                             class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                    ` : ''}
                                    <div class="col">
                                        <div class="link-preview-content">
                                            ${preview.title ? `
                                            <h6 class="mb-1 fw-bold">
                                                <a href="${preview.url}" target="_blank" class="text-decoration-none">
                                                    ${preview.title.substring(0, 80)}${preview.title.length > 80 ? '...' : ''}
                                                </a>
                                            </h6>
                                            ` : ''}
                                            ${preview.description ? `
                                            <p class="mb-1 text-muted small">
                                                ${preview.description.substring(0, 120)}${preview.description.length > 120 ? '...' : ''}
                                            </p>
                                            ` : ''}
                                            <div class="d-flex align-items-center text-muted small">
                                                ${preview.favicon ? `
                                                <img src="${preview.favicon}" alt="Site" 
                                                     class="me-1" style="width: 16px; height: 16px;">
                                                ` : ''}
                                                <span>${preview.site_name || preview.url.replace('https://', '').replace('http://', '')}</span>
                                                ${preview.type === 'oembed' ? '<i class="bi bi-lightning-fill ms-1 text-warning" title="Schnell-Vorschau"></i>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html;
                container.classList.remove('d-none');
                button.style.display = 'none';
            } else {
                button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Keine Vorschau verfügbar';
                button.classList.add('btn-outline-secondary');
                button.classList.remove('btn-outline-info');
            }
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Fehler beim Laden';
            button.classList.add('btn-outline-danger');
            button.classList.remove('btn-outline-info');
        })
        .finally(() => {
            button.disabled = false;
        });
}
</script>

<style>
/* Override content-area padding for this page */
.content-area {
    padding: 0 !important;
}

.article-card {
    border: none !important;
    border-radius: 0;
    background: white;
    margin-bottom: 1rem;
    box-shadow: none !important;
}

.rating-buttons-container {
    white-space: nowrap;
    font-size: 0; /* Removes space between inline-block elements */
    align-self: flex-start; /* Force top alignment */
}

.rating-buttons-container .btn {
    font-size: 0.85rem;
    margin: 0;
    border: none !important;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    min-width: 2rem;
    display: inline-block;
    vertical-align: top;
    line-height: 1.2;
    background: transparent !important;
}

/* Remove any borders/lines */
.article-card .article-body {
    border: none !important;
    box-shadow: none !important;
}

/* Ensure badges align to top */
.badge {
    vertical-align: top;
    line-height: 1.2;
}

.rating-buttons .btn.active {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.article-title {
    font-weight: 600;
    line-height: 1.3;
    text-decoration: none !important;
}

/* Explizit verhindern, dass Text durchgestrichen wird */
.article-card * {
    text-decoration: none !important;
}

.article-card .article-title a {
    text-decoration: none !important;
}

.article-card .content-preview,
.article-card .full-content {
    text-decoration: none !important;
}

.link-preview-card {
    border: 1px solid #dee2e6 !important;
    background: #f8f9fa !important;
}

/* Hide spam articles with smooth transition */
.article-card[data-spam="true"] {
    opacity: 0;
    transform: scale(0.95);
    transition: all 0.3s ease;
    pointer-events: none;
    height: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
    border: none;
}
</style>
{% endblock %}